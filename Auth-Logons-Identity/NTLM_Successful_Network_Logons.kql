// -----------------------------------------------------------------------------
// Query Name: NTLM_NetworkLogons_NoDomain_Success
// Description:
//   Identifies successful network logons that are likely using NTLM authentication,
//   based on missing domain information and other filtering criteria.
//
//   Filtering applied:
//     - LogonType == "Network"
//     - DeviceName does not contain common prefixes ("ip-", "ep-", "it", "id", "inf")
//     - Excludes machine accounts (AccountName ending in "$")
//     - RemoteIP must be present (indicates a remote login)
//     - ActionType == "LogonSuccess"
//     - AccountDomain is empty (suggests NTLM was used)
//
// Use cases:
//   - Detect devices and accounts authenticating over the network with NTLM
//   - Investigate potential legacy authentication still in use
//   - Highlight remote logon activity that may warrant deeper review
//
// Output fields:
//   Timestamp, AccountName, DeviceName, RemoteIP, AccountDomain, LogonType, ActionType
//
// Results are sorted by most recent logons first.
// -----------------------------------------------------------------------------

DeviceLogonEvents
| where LogonType == "Network"
| where DeviceName !contains "ip-" 
       and DeviceName !contains "ep-" 
       and DeviceName !contains "it" 
       and DeviceName !contains "id" 
       and DeviceName !contains "inf"
| where not(AccountName endswith "$")                  // Exclude machine accounts ending in $
| where isnotempty(RemoteIP)                           // Remote login = more likely NTLM
| where ActionType == "LogonSuccess"                   // Focus on successful logins
| where isempty(AccountDomain)                         // No domain info = likely NTLM
| project Timestamp, AccountName, DeviceName, RemoteIP, AccountDomain, LogonType, ActionType
| order by Timestamp desc
